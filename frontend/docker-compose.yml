services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: taxidermy-website-frontend-prod
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./logs/nginx:/var/log/nginx
    ports:
      - "3003:80"
    restart: on-failure

  goaccess:
    image: allinurl/goaccess:latest
    container_name: taxidermy-goaccess
    depends_on:
      - frontend
    volumes:
      - ./logs/nginx:/var/log/nginx:ro
      - ./logs/goaccess:/usr/share/goaccess
    ports:
      - "7890:7890"
    command: >
      /bin/sh -c "touch /var/log/nginx/access.log && \
      goaccess /var/log/nginx/access.log \
        --log-format=COMBINED \
        --real-time-html \
        --daemonize \
        --addr=0.0.0.0 \
        --port=7890 \
        -o /usr/share/goaccess/report.html"
